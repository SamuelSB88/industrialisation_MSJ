# ğŸ“˜ Rapport Technique â€” API PrÃ©diction du CoÃ»t Moyen (CM)

---

## ğŸ§© Objectif du projet

Ce projet a pour objectif de prÃ©dire le **coÃ»t moyen (CM)** dâ€™assurance Ã  partir de variables dâ€™entrÃ©e. Il repose sur un modÃ¨le XGBoost optimisÃ© via Optuna, encapsulÃ© dans une API web utilisant **FastAPI**.

---

## ğŸš€ Technologies utilisÃ©es

- **FastAPI** : pour exposer les modÃ¨les sous forme d'API REST performante
- **Pydantic** : pour la validation des donnÃ©es dâ€™entrÃ©e
- **Uvicorn** : serveur ASGI lÃ©ger pour lancer l'API
- **XGBoost** : algorithme de boosting performant pour la rÃ©gression
- **Optuna** : framework dâ€™optimisation dâ€™hyperparamÃ¨tres
- **Scikit-learn** : pour les outils de split, mÃ©triques, encodage
- **Joblib** : pour sÃ©rialiser/dÃ©-sÃ©rialiser le modÃ¨le (.pkl)
- **Pytest** : pour les tests unitaires

---

## ğŸ§ª Tests unitaires (fichier `test_pipeline_unit.py`)

### 1. `test_reduce_memory_usage()`
- VÃ©rifie que les colonnes numÃ©riques sont bien converties en types mÃ©moire rÃ©duite (`int8`, `float32`, etc.)
- Objectif : **optimisation mÃ©moire**

### 2. `test_compute_metrics()`
- VÃ©rifie que RMSE, rRMSE et MAPE sont correctement calculÃ©s Ã  partir de `y_true` et `y_pred`
- Objectif : **qualitÃ© de prÃ©diction**

### 3. `test_fill_missing()`
- VÃ©rifie que les colonnes numÃ©riques et catÃ©gorielles sont bien remplies (`0` ou `-999`) sans NaN
- Objectif : **prÃ©paration des donnÃ©es fiable**

---

## ğŸ§  Structure du modÃ¨le

Le modÃ¨le est encapsulÃ© dans une classe appelÃ©e `CMPredictor`. Elle regroupe :

| MÃ©thode                           | FonctionnalitÃ©                                                                 |
|-----------------------------------|--------------------------------------------------------------------------------|
| `reduce_memory_usage()`          | RÃ©duit l'empreinte mÃ©moire du DataFrame                                       |
| `prepare_benchmark()`            | CrÃ©e un split train/validation stratifiÃ© sur `CHARGE`                         |
| `fill_missing()`                 | Remplit les NaN : `0` pour numÃ©riques, `-999` pour catÃ©gorielles              |
| `compute_metrics()`              | Calcule RMSE, rRMSE, MAPE                                                     |
| `train()`                        | Lance Optuna pour chercher les meilleurs hyperparamÃ¨tres et encoder           |
| `predict()`                      | Effectue une prÃ©diction sur jeu de donnÃ©es en appliquant lâ€™encodeur          |
| `plot_distribution()`           | GÃ©nÃ¨re deux graphiques : histogramme CM rÃ©el, scatter log-log rÃ©el vs prÃ©d.  |

---

## ğŸŒ API REST - Routes disponibles

| Route               | MÃ©thode | Description                             |
|---------------------|--------|------------------------------------------|
| `/health`           | GET    | VÃ©rifie que lâ€™API est vivante            |
| `/predict_montant`  | POST   | PrÃ©dit le coÃ»t moyen (CM)                |

Exemple de requÃªte :

```json
{
  "data": [
    {
      "ID": 1,
      "ANNEE_ASSURANCE": 1,
      "VAR1": 12,
      "VAR2": "ACTA"
    }
  ]
}
```

---

## ğŸ“¦ Fichiers gÃ©nÃ©rÃ©s

- `best_model_encoder_cm_xgb.pkl` : modÃ¨le entraÃ®nÃ© + encodeur sauvegardÃ©s
- `cm_predictions.csv` : sortie de prÃ©diction sur les donnÃ©es de test

---

## ğŸ” Fichier `.pkl` : rÃ©utilisation

```python
from cm_predictor import CMPredictor
import joblib

predictor = CMPredictor()
predictor.model, predictor.encoder = joblib.load("best_model_encoder_cm_xgb.pkl")
predictor.predict(df, numeric_cols, cat_cols)
```

---

## ğŸ“ Arborescence projet (principaux fichiers)

```
â”œâ”€â”€ api_predict_cm.py
â”œâ”€â”€ main.py
â”œâ”€â”€ cm_predictor.py
â”œâ”€â”€ preprocessing.py
â”œâ”€â”€ test_pipeline_unit.py
â”œâ”€â”€ predict_from_pickle.py
â”œâ”€â”€ best_model_encoder_cm_xgb.pkl
â””â”€â”€ requirements.txt
```

---

## âœ… Prochaines amÃ©liorations possibles

- Ajout de `/predict_freq` avec un deuxiÃ¨me modÃ¨le
- Dockerisation pour dÃ©ploiement cloud
- Ajout de logs dâ€™erreur et vÃ©rifications de type avancÃ©es
